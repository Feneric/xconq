
RCS file: /cvs/xconq/xconq/kernel/run.c,v
Working file: run.c
head: 1.104
branch:
locks: strict
access list:
symbolic names:
	xconq-7_4_1-release: 1.61
	xconq-7_4-branch: 1.61.0.2
	xconq-7_4-branchpoint: 1.61
	xtconq-pre-removal: 1.43
	xconq-7_3_3-release: 1.34
	xconq-7_3_2-release: 1.34
	xconq-7_3_1-release: 1.34
	xconq-7_3-branch: 1.34.0.2
	xconq-7_3-branchpoint: 1.34
keyword substitution: kv
total revisions: 104;	selected revisions: 104
description:
----------------------------
revision 1.104
date: 2004/08/29 21:27:57;  author: kingdon;  state: Exp;  lines: +33 -59
	* kernel/run.c: Revert Eric's formations changes from 21 Aug 2004
	to make the "delay" key work again.
----------------------------
revision 1.103
date: 2004/08/22 00:12:26;  author: mcdonald;  state: Exp;  lines: +7 -4
Reduce buzzing when formations are in use.
Fix display bug: image would no longer update after a 'change-type'.
----------------------------
revision 1.102
date: 2004/08/21 20:31:52;  author: mcdonald;  state: Exp;  lines: +54 -31
Fix scheduling bug exacerbated by the use of formations.
Fix crash from attempting to update a display with a NULL 'dside'.
----------------------------
revision 1.101
date: 2004/08/19 00:58:57;  author: ronne;  state: Exp;  lines: +42 -32
Many bug fixes, some new features.
----------------------------
revision 1.100
date: 2004/07/14 21:02:06;  author: ronne;  state: Exp;  lines: +4 -0
Improve drawing of feature legends.
----------------------------
revision 1.99
date: 2004/06/27 01:05:30;  author: ronne;  state: Exp;  lines: +1 -1
Improvements to ai performance and combat reporting.
----------------------------
revision 1.98
date: 2004/06/26 15:45:37;  author: ronne;  state: Exp;  lines: +4 -0
Various bug fixes and improvements to the kernel.
----------------------------
revision 1.97
date: 2004/06/23 22:13:22;  author: ronne;  state: Exp;  lines: +7 -3
Fixes to build code and new setup option for indepside.
----------------------------
revision 1.96
date: 2004/06/20 20:25:29;  author: ronne;  state: Exp;  lines: +2 -0
Fix so that brainless building works again.
----------------------------
revision 1.95
date: 2004/06/14 00:02:35;  author: ronne;  state: Exp;  lines: +11 -3
Fix buzzing in the acp-independent build code.
----------------------------
revision 1.94
date: 2004/05/19 22:39:09;  author: ronne;  state: Exp;  lines: +0 -1
Fix various interface bugs.
----------------------------
revision 1.93
date: 2004/01/05 23:36:37;  author: ronne;  state: Exp;  lines: +21 -0
Add pre-flight checks of move commands to the ui code.
----------------------------
revision 1.92
date: 2003/11/29 17:22:46;  author: mcdonald;  state: Exp;  lines: +5 -4
Fix crash from attempting to enter a dead transport.
Cosmetic improvement of a comment.
----------------------------
revision 1.91
date: 2003/11/28 16:30:33;  author: mcdonald;  state: Exp;  lines: +14 -0
Fix bug that was causing segfaults in xform_unit.
Add safeguard to action directing code.
----------------------------
revision 1.90
date: 2003/11/22 02:44:35;  author: ronne;  state: Exp;  lines: +0 -2
Fix various problems.
----------------------------
revision 1.89
date: 2003/11/12 01:42:22;  author: ronne;  state: Exp;  lines: +9 -9
Fix two materials-related bugs.
----------------------------
revision 1.88
date: 2003/10/18 16:59:40;  author: ronne;  state: Exp;  lines: +22 -14
Overhaul of material handling code.
----------------------------
revision 1.87
date: 2003/07/13 22:12:13;  author: ronne;  state: Exp;  lines: +24 -13
Improvements and bug fixes to the research dialog.
----------------------------
revision 1.86
date: 2003/06/30 21:17:23;  author: ronne;  state: Exp;  lines: +17 -21
Fix bug in action debugging code.
----------------------------
revision 1.85
date: 2003/05/01 19:20:27;  author: ronne;  state: Exp;  lines: +6 -4
Rewrite and improve unit view code.
----------------------------
revision 1.84
date: 2002/12/30 20:58:20;  author: ronne;  state: Exp;  lines: +2 -2
Expurgate wrapx from the interfaces.
----------------------------
revision 1.83
date: 2002/10/08 18:21:32;  author: ronne;  state: Exp;  lines: +5 -0
Fix bad ttype crashes.
----------------------------
revision 1.82
date: 2002/09/21 21:31:33;  author: ronne;  state: Exp;  lines: +41 -29
Fixes to the research display code.
----------------------------
revision 1.81
date: 2002/08/07 13:22:03;  author: ronne;  state: Exp;  lines: +136 -111
Fix several ai and action bugs.
----------------------------
revision 1.80
date: 2002/07/21 22:15:24;  author: ronne;  state: Exp;  lines: +7 -4
More ai bug fixes.
----------------------------
revision 1.79
date: 2002/07/18 21:09:25;  author: kingdon;  state: Exp;  lines: +0 -8
	* kernel/run2.c: Move declarations of run_people and friends from
	run2.c and run.c to kernel.h
	* kernel/plan.c: Include ai.h instead of declaring variables
	explicitly.
----------------------------
revision 1.78
date: 2002/07/17 23:05:38;  author: ronne;  state: Exp;  lines: +5 -12
Fixes to the AI build code.
----------------------------
revision 1.77
date: 2002/07/01 23:47:32;  author: ronne;  state: Exp;  lines: +10 -5
Clean up ai_finish_movement code.
----------------------------
revision 1.76
date: 2002/06/28 23:41:25;  author: ronne;  state: Exp;  lines: +6 -1
Fix severe AI build bug.
----------------------------
revision 1.75
date: 2002/06/28 00:06:11;  author: ronne;  state: Exp;  lines: +25 -11
Fix AI buzzing in acp-indep build code.
----------------------------
revision 1.74
date: 2002/06/18 21:20:53;  author: ronne;  state: Exp;  lines: +2 -1
Fix terrain usage for moving advanced units.
----------------------------
revision 1.73
date: 2002/05/18 20:55:47;  author: kingdon;  state: Exp;  lines: +10 -15
	* kernel/run.c (run_advanced_units, allocate_used_cells): Rewrite
	multiplicative code to use integer arithmetic in the way that most
	of xconq does (returning 0 and starving could be because the old
	code would basically hope that ((float)100 / 100.0) was 1, but if
	integer 100 rounds down a bit when it becomes float, that would
	lose).  This also should fix a bug whereby granaries and the like
	do nothing in advances.g (the code was taking 150% and rounding it
	to the integer 1).
----------------------------
revision 1.72
date: 2002/05/12 14:49:29;  author: ronne;  state: Exp;  lines: +14 -0
Fix bug in cell usage code.
----------------------------
revision 1.71
date: 2002/05/11 20:49:41;  author: ronne;  state: Exp;  lines: +2 -4
Clean out unused variables.
----------------------------
revision 1.70
date: 2002/05/08 23:51:17;  author: ronne;  state: Exp;  lines: +6 -6
Make sources C++ compatible.
----------------------------
revision 1.69
date: 2002/04/25 19:13:37;  author: ronne;  state: Exp;  lines: +1 -1
Fix stalled unit bug.
----------------------------
revision 1.68
date: 2002/03/29 17:45:19;  author: ronne;  state: Exp;  lines: +6 -8
Streamline network code.
----------------------------
revision 1.67
date: 2002/03/23 21:48:12;  author: ronne;  state: Exp;  lines: +10 -0
Implement low level double-click filter.
----------------------------
revision 1.66
date: 2002/02/17 00:25:43;  author: ronne;  state: Exp;  lines: +10 -5
Fix sync errors and lockups in network code.
----------------------------
revision 1.65
date: 2001/02/21 19:46:08;  author: kingdon;  state: Exp;  lines: +9 -0
	* lib/advances.g: Comment the cash material, and the forum and
	marketplace units - they don't do anything.
	Add comment about advances which don't do anything.
	Make advances cost more at higher generations (otherwise the game
	degenerates into massive numbers of legions on each side around
	turn 25 or 30).
	Also require the navigation advance for the trireme so you don't
	the situation where you can build a trireme without canvas &c.
	* kernel/run.c (run_population): Comment out code which hardcodes
	the unit name "Granary" (the hardcoding is just too gross to live,
	but the whole concept seems odd, see comment for discussion).
----------------------------
revision 1.64
date: 2000/12/28 16:04:08;  author: shebs;  state: Exp;  lines: +37 -30
	Streamline handling of can-build testing, add cases for
	can-develop.
	* side.h (Side candevelop): New field.
	(side_can_develop): New macro.
	* side.c (create_side): Allocate candevelop.
	* run.c (update_canbuild_vector): Fill in candevelop vector too.
	* unit.c (unit_can_build_type): New function.
	* plan.c (plan_offense_support, plan_colonize_support,
	plan_explorer_support): Use it.
	* macunit.c (build_construction_menu): Ditto.
	* tkcmd.c (do_build): Ditto.
	* ccmd.c (do_build): Ditto.

	* tkcmd.c (do_fire, aux_fire_at): Rewrite to use same code for
	keyboard and menu select cases.
	(common_fire_at): New function.
	(do_fire_into, aux_fire_into, common_fire_into): Similarly.

	* macwins.c (adjust_construction_controls): Use could_create
	and could_develop.
----------------------------
revision 1.63
date: 2000/12/21 14:41:34;  author: shebs;  state: Exp;  lines: +21 -16
	Fix problems resulting from the last change.
	* game.h (DONE, NOADVANCE): Assign values different from NONATYPE.
	(NOUNIT): Remove, never used.
	* side.h (has_advance): Use DONE.
	* world.h (NOUSER): Move to here, set to 0.
	* world.c (allocate_area_users): Remove memset of layer.
	* generic.c (init_types): Remove unused debug print.
	(create_unit_type): Make array resizing work.
	(create_material_type, create_terrain_type, create_advance_type):
	New functions.
	* read.c (interp_mtype, interp_ttype, interp_atype): Use them.
	* run.c (apnbt_types): New static global.
	(auto_pick_new_build_task): Use it instead of tmp_u_array.

	* PROJECTS: Remove MAXUTYPES project.
----------------------------
revision 1.62
date: 2000/12/18 16:50:48;  author: shebs;  state: Exp;  lines: +35 -26
	Eliminate the macros MAXUTYPES, MAXTTYPES, MAXMTYPES, and
	MAXATYPES, size all type handling dynamically.
	* config.h (MAXUTYPES, MAXTTYPES, MAXMTYPES, MAXATYPES): Remove.
	* game.h (NONUTYPE, NONTTYPE, NONMTYPE, NONATYPE): Define to be -1.
	(count_terrain_subtypes, numcelltypes, numbordtypes, numconntypes,
	numcoattypes): Declare here instead of in world.h.
	(tmp_u_array, tmp_t_array): Declare.
	* gvar.def (edge-terrain, river-sink-terrain): Don't use type
	bounds.
	* table.def (adjacent-terrain-effect, terrain-exhaustion-type): Ditto.
	* utype.def (obsolete, wrecked-type): Ditto.
	* generic.c (count_terrain_subtypes, numcelltypes, etc): Move here
	from world.c.
	(tmp_u_array, tmp_t_array): New globals.
	(curmaxutypes, curmaxmtypes, curmaxttypes, curmaxatypes): Set to
	defaults convenient for the first allocation.
	(create_unit_type): New function.
	(disallow_more_unit_types, disallow_more_terrain_types): New functions.
	(allocate_table): Use them.
	* help.c (tm_table_row_desc): Remove, never used.
	* init.c (check_game_validity): Call disallow_* to make sure
	some type arrays are computed and cached.
	(calculate_globals): Ditto.
	(make_initial_materials): Use tmp_t_array.
	* mkrivers.c (make_up_river_borders): Ditto.
	* mkterr.c (elev_range, elev_lo, elev_hi, raw_range, raw_lo,
	raw_hi): New static globals.
	(compose_area, compose_earthlike_area): Use them.
	(make_random_terrain, fix_adjacent_terrain,
	flatten_liquid_terrain): Use tmp_t_array.
	* mkunits.c (make_countries): Dynalloc local arrays.
	(country_is_complete, make_independent_units): Use tmp_u_array.
	* nlang.c (ohd_nums, ohd_incomplete): New static globals.
	(others_here_desc, occupants_desc): Use them.
	* plan.c (plan_colonize_support): Use tmp_u_array.
	(gctc_supply): New static global.
	(good_cell_to_colonize): Use it.
	* ps.c (summary_of_seen_units_at): Use tmp_u_array.
	* read.c (default_supply): Remove, no longer to use.
	(init_predefined_symbols): Remove its setup.
	(interp_unit_default): Similarly.
	(interp_unit): Don't use default_supply.
	(interp_utype): Remove test for too many types, call
	create_unit_type.
	(interp_ttype, interp_mtype, interp_atype): Remove tests
	for too many types.
	(too_many_types): Remove, no longer needed.
	(rd_u_arr): New static global.
	(interp_standing_order, read_utype_doctrine): Use it.
	* run.c (rau_incrs): New static global.
	(run_advanced_units): Use it.
	(apr_type): New static global.
	(auto_pick_unit_research, auto_pick_side_research): Use it.
	(auto_pick_new_build_task): Use tmp_u_array.
	* run2.c (ttotals, uttotals): New static globals.
	(run_economy): Use them.
	* score.c (sum_property): Use tmp_u_array.
	* side.c (new_doctrine): Call disallow_more_unit_types.
	* supply.c (mad): New static global.
	(init_supply_system): Set it up.
	* unit.c (create_unit): Allocate numlivebytype and completenesses.
	(oc_numtypes): New static global.
	(can_occupy_unit): Use it.
	(toc_numtypes, type_can_occupy_cell): Similarly.
	(ocw_numtypes, can_occupy_cell_without): Similarly.
	(tocw_numtypes, type_can_occupy_cell_without): Similarly.
	(conn_num_types, can_occupy_conn_1): Similarly.
	(can_carry, type_can_occupy): Use tmp_u_array.
	(num_each_type, shared_each_type): New static globals.
	(eject_excess_occupants): Use them.
	(shortest_unique_name): Dynalloc firstuniq, use it as flag
	instead of shortestdone.
	(shortest_generic_name): Similarly.
	* write.c (write_table): Increase histogram size.

	* ai.c (atc_type): New static global.
	(assign_to_colonize): Use it.
	(pbt_prefs, pbt_fringe_terrain, pbt_enemy_types,
	pbt_num_to_transport): New static globals.
	(preferred_build_type): Use them.
	* ai.h (Strategy): Declare strengths etc as arrays of pointers
	instead of 2D arrays, unitlist and unitlistcount as pointers.
	(Theater): Similarly for numassigned, numneeded, etc.
	(strength_est, etc): New macros (not used yet).
	* iplayer.c (iru_numoffensive, iru_numdefensive): New static globals.
	(iplayer_review_units): Use them.
	* mplayer.c (mplayer_create_strategy): Allocate strength arrays.
	(create_theater): Dynalloc numassigned etc fields.
	(estimate_strengths, mplayer_read_strengths, mplayer_save_state):
	Change to pointer-to-pointer refs.
	(mru_numoffensive, mru_numdefensive): New static globals.
	(mplayer_review_units): Use them.
	* oplayer.c: Similarly.

	* cmd.c (gt_amts, gt_rslts): New static globals.
	(do_one_give, do_one_take): Use them.
	* ui.h (VP draw_materials): Make into a pointer.
	* ui.c (new_vp): Allocate draw_materials field.

	* maccmd.c (do_one_add_terrain): Use tmp_t_array.
	* macwins.c (side_research_dialog): Make participants static global.

	* tkconq.h (UI material_color, etc): Change from array to pointer.
	(UI cell_color, cell_shades): Rename from cellcolor and cellshades.
	(UI best_timages): Similarly.
	(UI unitpics, unitmasks, bestmimages): Remove, not used.
	(Map uvec, ustr, tvec, tstr): Change from array to pointer.
	* tkcmd.c (do_add_terrain, do_remove_terrain): Use tmp_t_array.
	(do_build): Use tmp_u_array.
	* tkinit.c (utype_indexes, mtype_indexes): Change to pointers.
	(init_display): Remove inits of unused fields, alloc space for
	cell_shades and material_color.
	(init_material_images): Remove setup of bestmimages.
	(init_terrain_images): Allocate for best_timages and terrpics.
	(init_shades): Use array-of-array refs to cell_shades.
	* tkmain.c (last_num_units_in_play, last_num_units_incomplete):
	Change from arrays to pointers.
	(init_redraws, update_unit_type_list): Allocate them.
	(create_map): Alloc map uvec, ustr, etc.
	* tkmap.c: Update refs to renamed fields.
	(MapW draw_aux_terrain, draw_materials): Make into pointers.

	* ccmd.c (do_build): Use tmp_u_array.
	* cconq.c (init_display): Use numutypes to size allocs.
	(ask_unit_type, ask_terrain_type): Use array of int instead of short.
	* cdraw.c (draw_type_list_entry): Init lasttypevisible from numutypes.

	* cconq.c (do_dir_2): Fix a variable name.
	* cconq.h: Use #else instead of #elif.
----------------------------
revision 1.61
date: 2000/11/30 17:08:26;  author: shebs;  state: Exp;  lines: +97 -97
	* unit.h (ai_controlled): New macro.
	* ai.c, iplayer.c, mplayer.c, plan.c, run.c, macunit.c: Use it
	everywhere.

	* ai.c (offensive_worth, defensive_worth): Break complicated
	expressions into several statements.
	* iplayer.c (iplayerinited): Remove, never used.
	(iplayer_react_to_new_side, iplayer_save_state,
	iplayer_theater_at, iplayer_at_desig): Remove, never used.
	* run.c (move_one_unit_multiple): Rework test of AI units
	needing to run task reactions.
	* task.c (execute_task): Don't skip to task reaction if unit
	is not AI controlled.
----------------------------
revision 1.60
date: 2000/11/24 01:17:18;  author: ronne;  state: Exp;  lines: +21 -49
General cleanup of kernel prototypes - part 3.
----------------------------
revision 1.59
date: 2000/11/16 23:33:12;  author: ronne;  state: Exp;  lines: +0 -1
General cleanup of kernel prototypes - part 2.
----------------------------
revision 1.58
date: 2000/11/12 00:39:54;  author: ronne;  state: Exp;  lines: +10 -3
General cleanup of kernel prototypes - part 1.
----------------------------
revision 1.57
date: 2000/10/29 21:10:37;  author: ronne;  state: Exp;  lines: +13 -6
Improve ai planning. More support for combat model 1.
----------------------------
revision 1.56
date: 2000/10/23 01:41:35;  author: ronne;  state: Exp;  lines: +12 -2
Various bug fixes and improvements.
----------------------------
revision 1.55
date: 2000/10/12 22:04:58;  author: ronne;  state: Exp;  lines: +2 -0
Rewrite new model 1 attack code.
----------------------------
revision 1.54
date: 2000/10/03 22:11:40;  author: ronne;  state: Exp;  lines: +5 -0
Define zero cps as unbuildable, fix some bugs.
----------------------------
revision 1.53
date: 2000/09/29 17:49:30;  author: ronne;  state: Exp;  lines: +0 -2
Fix units getting stuck in sleep mode.
----------------------------
revision 1.52
date: 2000/09/22 19:09:36;  author: ronne;  state: Exp;  lines: +3 -1
Improve mac closeups and popup dialogs.
----------------------------
revision 1.51
date: 2000/09/17 18:25:39;  author: ronne;  state: Exp;  lines: +0 -1
Fix end-of-turn problems when switching ais.
----------------------------
revision 1.50
date: 2000/09/17 01:07:57;  author: ronne;  state: Exp;  lines: +21 -13
Fix clear_task_outcomes.
----------------------------
revision 1.49
date: 2000/09/16 12:54:28;  author: shebs;  state: Exp;  lines: +123 -100
	* unit.h (unit_in_vector): New macro, access to unit vector.
	* ai.c (run_ai_plan_adjust): Use it.
	* cmd.c (apply_to_all_selected_units): Ditto.
	* run.c (units_still_acting, side_move_some_units): Ditto.
	* skelconq.c (list_actors): Ditto.
	* ui.c (autonext_unit, autonext_unit_inbox): Ditto.
	* maclist.c (draw_unit_list_entry, etc): Ditto.
	* macwins.c (get_selected_construction_unit, etc): Ditto.
	* cdraw.c (draw_unit_list_entry): Ditto.

	* run.c (need_ai_plan_research): Remove.
	(run_side_research): Don't set it.
	* ai.c (run_local_ai): Test numatypes instead of
	need_ai_plan_research.

	* run.c (side_move_some_units): Add more comments, use local vars
	for side->actionvector.
	(run_construction): Test side_has_ai instead of side_has_local_ai,
	fix occupant test.
----------------------------
revision 1.48
date: 2000/09/14 18:46:26;  author: ronne;  state: Exp;  lines: +0 -5
Fix hangs in acp-independent construction.
----------------------------
revision 1.47
date: 2000/09/10 05:45:40;  author: shebs;  state: Exp;  lines: +83 -266
	Random rewrites and reorgs resolving remote networking bugs.
	* ai.c (init_ai): Fill in side->rai for remote AIs.
	(set_side_ai): Simplify, and add feedback on results.
	(run_local_ais, run_ai_plan_adjust): Move here from run.c,
	test taskexecs instead of need_ai_task_reaction.
	* cmd.c (do_ai_side): Fix player feedback to reflect that
	network roundup may be necessary before state changes.
	* cmdline.c (option_width, option_height, option_circumference):
	New globals.
	(parse_world_option): Set these instead of pushing a variant.
	(set_variants_from_options): Call net_set_variant_value instead
	of pushing variant settings.
	(find_variant_from_name): New function.
	* init.c (start_player_pre_setup_stage): Call do_module_variants.
	(final_init): Report more data structure sizes.
	* kernel.h (set_variant_value): Declare.
	* kpublic.h (net_set_variant_value): Declare.
	* module.h (Variant newvalues): New field, array of new settings
	for variant.
	* module.c (create_game_module): Store a copy of the module name.
	(set_variant_value): Move here from tkmain.c.
	(do_one_variant): Fill from newvalues fields.
	* read.c (interp_variant_defns, add_std_var): Fill in newvalues
	fields.
	* run.c (latest_action_x, latest_action_y): New globals.
	(num_local_ais): Move to ai.c.
	(need_ai_task_reaction): Remove, use taskexecs instead.
	(save_run_state, clear_task_outcomes): New functions.
	(run_game): Call them.
	(move_one_unit_multiple): Replace need_ai_task_reaction test
	with last_task_outcome and AI usage test.
	(run_side_research, run_construction): Test local AI instead
	of AI in general (dubious).
	* side.h (Side rai): New field.
	(side_has_ai): Test both local and remote AI.
	(side_has_local_ai): New macro.
	* task.c (execute_task): Rework recording of task outcome.
	* tp.h (RAI): New struct, placeholder "remote AI".
	* tp.c: Change run warnings into notices.
	(net_set_variant_value): New function.
	(receive_variant_settings): Allow at most three values.
	* write.c (write_side_properties): Only write AI state for
	local AIs (dubious).

	* tkconq.tcl: Rewrite variant handling to do more work in
	kernel.
	(set_variant_value_cmd): New proc, replaces broadcast_variant_value.
	(set_variants): Do less.
	(add_world_size_dialog_items): Comment out lat/lon items.
	(insert_chat_string): Test for existence of window before insert.
	* tkmain.c: Rewrite for variants also.
	(send_value_value, implement_variants): Remove tcl commands.
	(tk_set_variant_value): Rewrite to pass along to kernel.
	(interpret_variants): Rewrite.
	(set_variant_world_size, set_variant_real_time): Remove,
	handled uniformly in kernel.
	(update_variant_setting): Rewrite.
----------------------------
revision 1.46
date: 2000/09/08 20:55:02;  author: ronne;  state: Exp;  lines: +1 -0
Fix prototype.
----------------------------
revision 1.45
date: 2000/09/03 22:52:27;  author: shebs;  state: Exp;  lines: +37 -34
	* actions.c, read.c, unit.c: Use more new-style function defns.
	* run.c: Add some comments.
	* run2.c: Remove unused decls.
	* world.c, world.h (compute_elevation_bounds): New function, split
	out from final_init_world.
	* read.c (fill_in_elevations): Call it.
	* write.c (write_area_elevations): Change to write only
	nonnegative values.
----------------------------
revision 1.44
date: 2000/08/25 22:19:11;  author: ronne;  state: Exp;  lines: +6 -0
Fix indepside-related research hangs.
----------------------------
revision 1.43
date: 2000/08/21 21:34:35;  author: ronne;  state: Exp;  lines: +6 -7
Consolidate for_all_sides macros.
----------------------------
revision 1.42
date: 2000/08/20 20:25:05;  author: ronne;  state: Exp;  lines: +185 -73
More changes to construction and research.
----------------------------
revision 1.41
date: 2000/08/18 23:42:55;  author: ronne;  state: Exp;  lines: +236 -166
Move acp-indep builds to normal execution code.
----------------------------
revision 1.40
date: 2000/08/15 23:42:55;  author: ronne;  state: Exp;  lines: +26 -26
Clean up and simplify advanced unit code.
----------------------------
revision 1.39
date: 2000/08/08 17:11:52;  author: shebs;  state: Exp;  lines: +37 -37
	* nlang.c (tooling_desc): New function.
	(notify_doctrine): List contents of all doctrines.
	(notify_doctrine_1): List construction run lengths.
	* plan.c (est_completion_time): Move to here from nlang.c.
	* read.c (read_default_doctrine): Rename from read_general_doctrine,
	don't try to handle property values here.
	(read_utype_doctrine): Similarly.
	(utype_from_name): Handle empty strings.
	* read2.c (interp_utype_list): Move to here from unit.c.
	* side.h (Side numlive): Remove field, never used.
	(for_all_doctrines): New macro.
	* side.c (init_sides): Set next_doctrine_id to 1, so save/restore
	doesn't get confused.
	(create_side): Don't alloc space for numlive.
	(become_designer): Don't enable may_set_show_all if see_all.
	(cover_area): Test side->see_all instead of g_see_all.
	(new_doctrine): Ensure new doctrine has unique id.
	(clone_doctrine): Comment out, never used.
	* unit.c (set_unit_side): Remove adjust of numlive.
	(find_unit_name): Remove, unused and useless.
	(num_occupants, num_units_at, get_x_property_by_name): Comment
	out, never used.
	* write.c: Cosmetic improvements.
	* conq.h, unit.h: Update to reflect movements.
----------------------------
revision 1.38
date: 2000/07/30 23:39:41;  author: ronne;  state: Exp;  lines: +8 -0
Speed improvements of some cpu hogs.
----------------------------
revision 1.37
date: 2000/07/30 14:45:44;  author: ronne;  state: Exp;  lines: +6 -2
Fix crashing bug in has_advance_to_build.
----------------------------
revision 1.36
date: 2000/07/30 13:06:43;  author: ronne;  state: Exp;  lines: +56 -9
Cache research and build vectors, make ai resignation optional.
----------------------------
revision 1.35
date: 2000/06/20 16:23:43;  author: shebs;  state: Exp;  lines: +0 -1
	* config.h: Remove ANSI_PROTOTYPES and __STDC__ conditionals.
	* misc.h (PARAMS): Remove decl.
	* obstack.h, obstack.c: Remove uses of PARAMS and ANSI_PROTOTYPES.
	* macinit.c, macmenus.c, macmouse.c: Ditto.
	* xcmd.c, xdesign.c, xhelp.c, ximf.c, xinit.c, xprint.c, xtmain.c:
	Ditto.

	* iplayer.c, mkrivers.c, mplayer.c, run.c, util.c, write.c: Remove
	some redundant function decls.
	* macwins.c: Ditto.
	* tkimf.c: Remove unused decl.
----------------------------
revision 1.34
date: 2000/06/04 16:19:03;  author: shebs;  state: Exp;  lines: +6 -5
	More rewriting of variant handling and player setup.
	* keyword.def (indepside-has-ai, indepside-can-build,
	indepside-can-research, indepside-has-treasury): Comment out,
	will no longer define as variants.
	* ai.c, ai.h (next_ai_type_name): Rename from next_ai_type.
	(find_ai_type): New function.
	* cmdline.c (unixify_variant_name): Remove.
	(game_usage_info): Use variant ids as argument names.
	* kernel.h (set_ai_for_player, etc): Move here from conq.h.
	* init.c (make_up_a_side): Remove set of ingame, redundant.
	(set_ai_for_player): Warn about invalid AI types.
	* iplayer.c, mplayer.c: Remove decls now in ai.h.
	* kpublic.h: Rearrange some decls.
	* module.c (do_one_variant): Remove indepside variants.
	* read.c (force_all_variants): New global.
	(add_std_var): New function.
	(interp_variant_defns): Rewrite to use it for all variant
	setup.
	(add_more_variants): Remove, no longer needed.
	(interp_game_module): Call interp_variant_defns.
	* run.c (init_movement): Simplify code.
	* score.c (eval_sk_last_side_wins, eval_sk_last_alliance_wins):
	Don't require indepside to lose.
	(record_into_scorefile): Use a switch statement for variants.
	(score_variant_desc): Remove indepside variants.

	* macinit.c (interpret_variants, implement_variants): Remove
	indepside variants.
	(hit_player_setup_dialog): Use net_exchange_players.

	* tkconq.tcl (add_variants_dialog_items): Wrap help text by
	words.
	(add_player_dialog_items): Always create indepside entry but
	conditionalize packing, add indepside button, improve test of
	random/sidelib name button enabling.
	(popup_indepside, ok_indepside): New procs.
	* tkinit.c (init_display): Seed indepside globals.
	* tkmain.c (tk_set_indepside_options): New tcl command.
	(tk_set_ai_for_player): Interpret AI name passed directly.
	(interpret_variants): Remove indepside variants.
----------------------------
revision 1.33
date: 2000/04/24 13:04:09;  author: shebs;  state: Exp;  lines: +29 -34
	* run.c, side.c: Cosmetic improvements.
----------------------------
revision 1.32
date: 2000/04/08 14:58:22;  author: ronne;  state: Exp;  lines: +25 -0
Add side->autoresearch option.
----------------------------
revision 1.31
date: 2000/04/07 17:19:35;  author: shebs;  state: Exp;  lines: +0 -1
	* ai.c (next_ai_type): Simplify.
	* conq.h (has_advance_to_research): Declare here.
	* cmd.c, run.c, macunit.c, macwins.c: ...instead of here.
	* combat.c: Cosmetic changes.
	* iplayer.c: Remove more unused code, elim warnings.
	* mplayer.c (mp_collect_here): Declare.
	* plan.c: Comment out unused code.
	* supply.c: Remove unused globals.
----------------------------
revision 1.30
date: 2000/04/06 13:09:12;  author: shebs;  state: Exp;  lines: +7 -7
	* game.h (for_all_border_types, for_all_connection_types): Move
	to here from supply.c.
	* generic.c (first_bord_type, next_bord_type, first_conn_type,
	next_conn_type): New globals.
	* world.c (count_terrain_subtypes): Calculate values for these.
	* supply.c (optimize_terrain): Remove, no longer needed.
	* move.c, nlang.c, ps.c, run.c, task.c, ui.c, unit.c, macrow.c:
	Use the macros everywhere.
	* nlang.c (linear_desc): Comment out info about directions.
	(location_desc): Attach linear desc to terrain name only.
	* ui.c (toggle_user_at): Add error messages for failures.
----------------------------
revision 1.29
date: 2000/04/02 23:26:10;  author: shebs;  state: Exp;  lines: +13 -7
	* plan.c, run.c, ui.c: Confirm that user layer exists before
	calling user_at.
	* run.c (run_advanced_units): Allocate user layer here.
	* ui.c (collect_possible_games): Remove Mac-specific code, never
	used.
	(oneliner): Use apparent_unit_handle to describe some units.
----------------------------
revision 1.28
date: 2000/03/11 17:24:04;  author: shebs;  state: Exp;  lines: +3 -0
	* run.c (run_game): Stop game action if any designers active.
----------------------------
revision 1.27
date: 2000/03/05 16:10:32;  author: shebs;  state: Exp;  lines: +1 -2
overlooked change
----------------------------
revision 1.26
date: 2000/03/05 15:41:53;  author: shebs;  state: Exp;  lines: +21 -5
	* cmd.c (do_research): Let "research nothing" stop research.
	* run.c (units_still_acting): Don't end turn if research topic
	still needs to be chosen.
	(run_population): Add a hack for effects of "Granary".
	* run2.c (run_side_research): Skip if researchers resting.

	* tkconq.tcl (popup_splash_screen): Improve button names.
	(fill_in_side_list): Omit default scorekeeper text.
	(popup_research_dialog): Add "Rest" button.
	(rest_research): New proc.
	* tkmain.c (update_side_display): Move research popup to here
	from update_turn_display.
	(tk_set_side_research): Handle resting case.
----------------------------
revision 1.25
date: 2000/02/06 21:54:50;  author: ronne;  state: Exp;  lines: +4 -4
Various mac interface improvements.
----------------------------
revision 1.24
date: 1999/12/14 03:13:02;  author: shebs;  state: Exp;  lines: +19 -19
	* side.h (Side c_rates): New field.
	* cmd.def (c-rate): New command, sets material conversion rates.
	* cmd.c (do_c_rate): New function.
	* run.c (run_advanced_units): Rewrite conversion to use user
	specified rates.
----------------------------
revision 1.23
date: 1999/12/09 22:58:47;  author: shebs;  state: Exp;  lines: +27 -7
	* run.c (production_at): New function.
	(run_advanced_units, allocate_used_cells): Use it.
----------------------------
revision 1.22
date: 1999/12/08 03:13:10;  author: shebs;  state: Exp;  lines: +65 -30
	* gvar.def (side-can-research): New global.
	* table.def (conversion): New material-material table.
	* utype.def (advanced-auto-construct, advanced-auto-research,
	use-own-cell): New properties.
	* cmd.c (do_research): Use new global, test for more cases.
	* iplayer.c (iplayer_save_state): Removed unneeded code.
	* kpublic.h (net_set_side_research): Declare.
	* nlang.c (UsualDateStepRange): New struct.
	(date_step_ranges): New array, was datesteptype.
	(init_calendar): Handle ranges of turns for date steps.
	(parse_date_step_range): New function.
	(parse_usual_date): Add arg, change all callers.
	(usual_date_string): Search ranges to find right step type.
	* plan.c (execute_plan): Comment out advanced unit escape.
	* run.c (run_advanced_units): Add material conversion step.
	(run_population): Use unit_handle.
	(allocate_used_cells): Make extra cell usage optional, don't
	handle inside search loop.
	* run2.c (run_side_research): Use material consumption.
	* tp.c (net_set_side_research): New function.
	(receive_side_prop): Handle side research packet.
----------------------------
revision 1.21
date: 1999/12/01 04:14:44;  author: shebs;  state: Exp;  lines: +12 -8
	* nlang.c (size_desc): New function.
	* run.c (run_construction): Handle missing unit plan.
	(allocate_used_cells): Use main city cell for free, test for
	independence correctly.
	* run2.c (run_side_research): New function.
	(run_turn_start): Call it.
	* side.h (Side research_topic): New field.
	* side.c (create_side): Set it.
	(set_side_research): New function.
	* ui.c (oneliner): Describe usage of cell.
	* unit.c (has_advance_to_build): Remove type if obsolete.
----------------------------
revision 1.20
date: 1999/10/30 14:41:46;  author: shebs;  state: Exp;  lines: +3 -3
        * combat.c (mobile_enemy_thread): Use side_sees_image instead of
        unit_actually_visible.
        * run.c (auto_pick_new_build_task, etc): Ditto.
        * task.c: Ditto.
        * side.c (side_sees_unit): Add side->see_all case, remove
        designer and debugging cases.
        (side_sees_image): Error if NULL side, add view-matching case.
        * ui.c (unit_actually_visible): Comment out.
        (unit_visible, occupants_visible): New function.
        (cell_terrain): Remove, fold code into oneliner.
        (oneliner): Test vp->show_all.
        * ui.h: Declare new functions.

        * conq.h (gameinited, warnings_logged): Declare.
        (add_remote_players, etc): Ditto.
        * cmd.c, cmdline.h, init.c, read.c, read2.c, side.c, unit.c,
        util.c: Remove unneeded decls.
        * misc.h (log_warning): Declare.
----------------------------
revision 1.19
date: 1999/10/26 15:32:09;  author: shebs;  state: Exp;  lines: +5 -2
        Reorganize see-all handling, add separate concept of show-all
        that only affects display.
        * side.h (Side show_all): New field.
        (Side may_set_show_all): Rename from may_set_see_all.
        * ui.h (VP show_all): Rename from see_all.
        * init.c (init_all_views): Use new field, don't set all_see_all.
        * actions.c, ai.c. combat.c, mplayer.c, nlang.c, plan.c, ps.c,
        read.c, run.c, run2.c, score.c, side.c, side.h, ui.c, unit.c,
        write.c: Use g_see_all() or side->see_all instead of all_see_all,
        side->may_set_show_all instead of side->may_set_see_all.
        * macconq.c, macdesign.c, macmap.c, macmouse.c, macrow.c: Ditto.
        * tkcmd.c, tkmain.c, tkmap.c: Ditto.
        * xcmd.c, xmap.c, xtmain.c: Ditto.
        * run.c (end_the_game): Set side->show_all.
        * side.c (become_designer, become_nondesigner): Ditto.

        * tkcmd.c (aux_design, really_do_design): Call set_show_all and
        update_show_all_info.
        * tkconq.tcl (may_set_show_all): Rename from may_set_see_all.
        (default_map_options): New global array, use everywhere instead
        of map_options.
        (map_options): Index by map widget also.
        (update_view_controls_info): Don't set may_set_show_all.
        (update_show_all_info, update_show_all): New procs.
        * tkinit.c (init_display): Update show_all info.
        * tkmain.c (update_turn_display): Set show_all.
        * tkmap.c (m_terrain_visible, m_units_visible): New macros, use
        everywhere.
        (set_show_all): New function.

        * combat.c (do_overrun_action): Fix call to do_fire_at_action
        to not shoot at self(!).

        * side.c (paint_view_1): Add special case to do exact view.

        * unix.c (score_file_pathname): Look for env var XCONQ_SCORES
        instead of XCONQSCORES.

        * tkconq.h (UI told_outcome): Remove, never used.
        * tkmain.c (told_outcome): Make static local.
        * tkconq.tcl (disable_move_mode): New proc.
        (popup_game_over_dialog): Use it.
        (popup_design_palette): Add view painting button.
        (make_view_paint_frame): New proc.
        (make_terrain_paint_frame): Increase size of terrain samples.
        (make_people_paint_frame, make_control_paint_frame): Turn on
        people/control display in all maps.
        * tkinit.c (init_bitmaps): Add paint_view bitmap.
        * tkmap.c (handle_designer_mouse_down, paint_on_drag): Rewrite
        view painting.
----------------------------
revision 1.18
date: 1999/10/25 23:11:05;  author: ronne;  state: Exp;  lines: +12 -20
Clean out more NULL side stuff.
----------------------------
revision 1.17
date: 1999/10/25 21:10:41;  author: ronne;  state: Exp;  lines: +1 -1
Clean out NULL side stuff, fix some bugs.
----------------------------
revision 1.16
date: 1999/10/24 11:20:10;  author: ronne;  state: Exp;  lines: +35 -31
Add new indepside code, fix various bugs.
----------------------------
revision 1.15
date: 1999/10/07 02:27:04;  author: shebs;  state: Exp;  lines: +58 -37
	* unit.h (has_acp_left): New macro, accounts for acp-min.
	* plan.c (occupant_can_capture_neighbor): Use it.
	* run.c (side_move_some_units, unit_still_acting,
	unit_still_acting_no_plan, move_one_unit_multiple): Ditto.
	* side.c (find_next_mover, find_prev_mover, find_next_awake_mover,
 	find_prev_awake_mover): Ditto.
	* ui.c (could_be_next_unit): Ditto.
	* macconq.c (maybe_select_next_unit): Ditto.
	* macmap.c (draw_selected_unit, draw_selection_animation): Ditto.
	* macmouse.c (select_another): Ditto.
	* tkmain.c (tk_run_game_idle): Ditto.
	* tkmap.c (draw_current): Ditto.
	* xcloseup.c (build_unit_list): Ditto.
	* xdraw.c (draw_current): Ditto.
	* cconq.c (maybe_handle_input): Ditto.
	* cdraw.c (draw_unit_list_entry): Ditto.

	* run.c (num_local_ais): New global.
	(run_local_ai): Use it to decide whether to run.

	* tkmain.c (tk_run_game): Return a smaller re-run interval.
	(tk_animate_selection): Record in activity trace.
----------------------------
revision 1.14
date: 1999/09/26 15:53:57;  author: ronne;  state: Exp;  lines: +38 -32
Fix null side crashes when calling terrain_visible.
----------------------------
revision 1.13
date: 1999/09/24 23:28:17;  author: ronne;  state: Exp;  lines: +32 -6
Limit action reaction to nearby units.
----------------------------
revision 1.12
date: 1999/09/19 16:04:35;  author: ronne;  state: Exp;  lines: +17 -9
Add more notices for advanced units.
----------------------------
revision 1.11
date: 1999/09/17 22:07:08;  author: ronne;  state: Exp;  lines: +48 -0
Add explanatory comments in run_local_ai.
----------------------------
revision 1.10
date: 1999/09/09 22:26:58;  author: ronne;  state: Exp;  lines: +54 -0
Move new ai code to action_reaction hook, fix some bugs.
----------------------------
revision 1.9
date: 1999/09/05 17:25:05;  author: ronne;  state: Exp;  lines: +7 -14
Rewrite new ai code. Fix various other bugs.
----------------------------
revision 1.8
date: 1999/09/05 12:32:01;  author: shebs;  state: Exp;  lines: +14 -14
        * run.c: Remove PARAMS usages.
        * run2.c: Cosmetic improvements.
----------------------------
revision 1.7
date: 1999/08/19 12:49:19;  author: shebs;  state: Exp;  lines: +5 -3
        * run.c (run_local_ai): Comment out plan update and emergency
        handling code, need to refigure how to do.
        (run_game): Add execute_plan result to planexecs.
        * plan.c (execute_plan): Return number of plan executions.
        * task.c: Tweak comments.
----------------------------
revision 1.6
date: 1999/08/12 03:15:07;  author: shebs;  state: Exp;  lines: +23 -13
	* run.c: Remove some unused decls, pass only one arg to
 	execute_plan.
	(move_some_units): Compute result as sum, not max.
	(run_local_ai): Move AI calls here from execute_plan.
	* plan.c (execute_plan, plan_passive): Remove second arg.
	(execute_plan): Remove AI calls, can't do from inside kernel.
	(self_build_base_for_self): Tweak paren grouping.
	(plan_colonizer_support): Comment out, not used.
----------------------------
revision 1.5
date: 1999/08/10 11:13:46;  author: shebs;  state: Exp;  lines: +10 -2
        Add a timeline collection and display mechanism.
        * util.c (TimelineBlock): New structure, storage for collected
        timeline info.
        (record_activity_start, record_activity_end, dump_activity_trace):
        New functions.
        * run.c (run_game, run_local_ai): Record start/end times.
        * tkcmd.c (do_trace): Toggle activity tracing.
----------------------------
revision 1.4
date: 1999/07/03 12:44:02;  author: ronne;  state: Exp;  lines: +0 -20
Clean up file, remove old change markers.
----------------------------
revision 1.3
date: 1999/06/02 19:28:44;  author: shebs;  state: Exp;  lines: +328 -349
	* ai.c: Reformat to standard.
	(offensive_worth, defensive_worth): Handle zero case.
	* combat.c: Reformat to standard.
	* mplayer.c (mplayer_update_plan): Reformat to standard,
	add more tests for null pointers.
	(defended_by_occupants): Similarly.
	* run.c (run_construction): Check before dereferencing null
	pointers, reformat to standard.
----------------------------
revision 1.2
date: 1999/06/01 19:39:58;  author: shebs;  state: Exp;  lines: +384 -193
Tue Jun  1 18:41:59 1999  Hans Ronne  <ronne@bmc.uu.se>
	* combat.c, conq.h, game.h, help.c, init.c, keyword.def,
 	mkunits.c, move.c, mplayer.c, plan.def, read.c, run.c, run2.c,
 	score.c, side.h, supply.c, table.def, ui.c, unit.c, unit.h,
 	utype.def, world.c, world.h, write.c, maccmd.c, maccolors.c,
 	macconq.h, macdefs.h, macdraw.c, macinit.c. maclist.c, macmap.c,
 	macmenus.c, macmouse.c, macprefs.c, macrow.c. macwins.c: Remove
 	old change markers.
	* actions.c (transfer_supply): Disable use of indepside treasury.
	(do_create_in_action): Make separate call to has_advance_to_build.
	(do_create_in_action): Use the builders stash of cps if allowed.
	(do_create_in_action): Fix null side treasury crashes.
	(check_create_common): Make separate call to has_advance_to_build.
	(check_create_common): Fix null side treasury crashes.
	(set_created_unit_props): Turn on automation for indeps & AI
 	controlled sides.
	(do_create_at_action): Make separate call to has_advance_to_build.
	(do_create_at_action): Use the builders stash of cps if allowed.
	(do_create_at_action): Fix null side treasury crashes.
	(make_unit_complete): Fix null actionvector crashes at turn zero.
	(do_transfer_part_action): Make separate call to
 	has_advance_to_build.
	(check_change_type_action): Add separate call to
 	has_advance_to_build.
	* ai.c (numaitypes): Move to config.h to make it globally
 	accessible.
	(set_side_ai): Turn on automation for indeps & AI controlled
 	sides.
	(ai_update_plan): New function.
	(goal_truth): Handle GOAL_UNIT_OCCUPIED and GOAL_COLONIZE.
	(ai_init_shared): Call set_u_is_ground_mobile etc.
	(ai_init_shared): Set u_colonizer.
	(ai_init_shared): Call set_u_offensive_worth etc.
	(ai_init_shared): Set u_naval_mobile, u_ground_mobile and
 	u_facility.
	(offensive_worth): New function.
	(defensive_worth): New function.
	(exploring_worth): New function.
	(colonizing_worth): New function.
	(facility_worth): New function.
	(siege_worth): New function.
	(random_worth): New function.
	(set_u_offensive_worth): New function.
	(set_u_defensive_worth): New function.
	(set_u_explorer_worth): New function.
	(set_u_colonizer_worth): New function.
	(set_u_facility_worth): New unction.
	(set_u_random_worth): New function.
	(set_u_siege_worth): New function.
	(set_u_is_ground_mobile): New function.
	(set_u_is_naval_mobile): New function.
	(set_u_is_air_mobile): New function.
	(set_u_is_advanced): New function.
	(set_u_is_colonizer): New function.
	(set_u_is_facility): New function.
	* ai.h (a_ai_op): Add (*to_update_plan).
	(ai_update_plan): Prototype new function.
	(offensive_worth, defensive_worth, etc): New prototype.
	* combat.c (do_overrun_action): Make ovverun after fire possible.
	(check_overrun_action): Make overrun after fire & into empty cell
 	possible.
	(do_fire_at_action): Use SideMask code to handle fire display.
	(do_fire_at_action): Permit attempt to capture after fire from
 	adjacent cell.
	(do_fire_into_action): Use SideMask code to handle fire display.
	(maybe_hit_unit): Support uu_cellwide_protection_against.
	(maybe_hit_unit): Support uu_cellwide_protection_for.
	(maybe_hit_unit): Use SideMask code to handle hit display.
	(maybe_hit_unit): Fix occupant recursion bug.
	(attempt_to_capture_unit): Support uu_cellwide_protection_against.
	(attempt_to_capture_unit): Support uu_cellwide_protection_for.
	(detonate_on_cell): Use for_all_stack_with_occs instead of
 	for_all_stack.
	(can_capture_directly): New function.
	(type_can_capture_directly): New function.
	(type_can_carry): New function.
	(occ_can_defend_transport): New function.
	* config.h (MAXATYPES): Increase to 254.
	(numaitypes): Move here from ai.c to make it globally accessible.
	* conq.h (advanced_utypes etc): Remove.
	(numadv etc): Remove.
	(can_extract_at): Prototype.
	(can_load_at): Prototype.
	(can_capture_directly): Prototype.
	(type_can_capture_directly): Prototype.
	(type_can_carry): Prototype.
	(occ_can_defend_transport): Prototype.
	(has_advance_to_build): Prototype.
	(unit_actually_visible): New prototype.
	* game.h (for_all_advanced_utypes, etc): Remove.
	* goal.def (GOAL_UNIT_OCCUPIED, GOAL_COLONIZE): New goals.
	* gvar.def (g_default_runlength): New name for
 	g_ai_build_runlength.
	(g_disable_standard_economy): New gvar.
	(g_disband_unfinished_units): New gvar.
	(g_salvage_unfinished_cps): New gvar.
	(g_salvage_unfinished_materials): New gvar.
	(g_ai_advanced_unit_separation): New gvar.
	(g_ai_badtask_remove_chance): New gvar.
	(g_ai_badtask_max_retries): New gvar.
	(g_ai_badtask_reserve_chance): New gvar.
	(g_units_may_go_into_reserve): New gvar.
	(g_units_may_go_to_sleep): New gvar.
	* help.c (may_detonate): Prototype.
	(describe_utype): Make display of Material Handling conditional.
	(describe_utype): Add "None" option to required advances code.
	(u_property_desc, etc): Add spaces after commas to permit new
 	lines.
	(append_help_phrase): Add more dashes and an extra linefeed.
	* imf.c (interp_image): Disable palette run warning on the Mac.
	* init.c (advanced_utypes etc): Remove.
	(final_init): Remove call to setup_utype_vectors.
	(setup_utype_vectors): Remove function.
	* kernel.h (go_after_captive): New prototype.
	(attack_can_damage_or_capture): New prototype.
	(fire_can_damage_or_capture): New prototype.
	(real_capture_chance): New prototype.
	* keyword.def (K_AUTOPLAN): New keyword.
	(K_CP_STASH): New keyword.
	* kpublic.h (net_resume_build_task): New extern prototype.
	* mac.c: Include MacTypes.h ifdef NEW_HEADERS, else include
 	Types.h.
	* mkunits.c (make_countries): Add separate call to
 	has_advance_to_build.
	(place_unit): Add separate call to has_advance_to_build.
	* move.c (do_move_action): Fix u2->nu2 typo & remove nu2
 	declaration.
	(do_enter_action): Fix u2->nu2 typo & remove nu2 declaration.
	* mplayer.c: Include kernel.h.
	(assign_to_defend_unit): Prototype new function.
	(assign_to_defend_cell): Prototype new function.
	(assign_to_defend_vicinity): Prototype new function.
	(mplayer_update_plan): Prototype new function.
	(defended_by_occupants): Prototype new function.
	(mplayer_ops): Add mplayer_update_plan.
	(update_unit_plans_randomly): Support g_units_may_go_into_reserve.
	(update_unit_plans_randomly): Support g_units_may_go_to_sleep.
	(mplayer_decide_plan): Skip for advanced units.
	(mplayer_decide_plan): Use u_colonizer_worth instead of
 	u_colonizer.
	(mplayer_update_plan): New function.
	(need_this_type_to_build_explorers): Check that we can build the
 	desired type.
	(assign_to_colonize): Rewrite. Use GOAL_COLONIZE and
 	PLAN_COLONIZING.
	(assign_to_improve): Clear task agenda and set NULL goal.
	(type_can_build_attackers): Check that we can build the desired
 	type.
	(type_can_build_colonizers): Add separate call to
 	has_advance_to_build.
	(type_can_build_colonizers): Use u_colonizer_worth instead of
 	u_colonizer.
	(preferred_build_type): Also count enemy occs by using
 	for_all_stack_with_occs.
	(preferred_build_type): Add separate call to has_advance_to_build.
	(preferred_build_type): Use u_colonizer_worth instead of
 	u_colonizer.
	(defended_by_occupants): New function.
	(assign_to_defense): Rewrite. Handle defense of units.
	(assign_to_defend_unit): New function.
	(assign_to_defend_cell): New function.
	(assign_to_defend_vicinity): New function.
	(assign_to_defend_theater): New function.
	(mplayer_adjust_plan): Skip for advanced units.
	(mplayer_adjust_plan): Add PLAN_COLONIZING & PLAN_IMPROVING.
	(mplayer_adjust_plan): Support g_units_may_go_into_reserve.
	(build_base_for_self): Check that we can build the desired type.
	(build_base_for_others): Check that we can build the desired type.
	(build_depot_for_self): Check that we can build the desired type.
	(rethink_plan): Support g_units_may_go_into_reserve.
	* plan.c: (execute_plan): Skip for advanced units.
	(execute_plan): Mark obsolete try code.
	(execute_plan): Support g_units_may_go_into_reserve.
	(execute_plan): Call ai_update_plan before execution.
	(plan_offense): Handle GOAL_UNIT_OCCUPIED and GOAL_CELL_OCCUPIED.
	(plan_offense): Support g_units_may_go_into_reserve.
	(plan_offense): Support g_units_may_go_to_sleep.
	(self_build_base_for_self): Check that we can build the desired
 	type.
	(plan_offense_support): Check that we can build the desired type.
	(plan_defense): Handle GOAL_UNIT_OCCUPIED and GOAL_CELL_OCCUPIED.
	(plan_defense): Call go_after_victim also for unit that can fire.
	(plan_defense): Use u_ai_tactical_range.
	(plan_defense): Support g_units_may_go_into_reserve.
	(plan_colonize): Rewrite. Use GOAL_COLONIZE.
	(plan_colonizer_support): Add separate call to
 	has_advance_to_build (2 times).
	(plan_colonizer_support): Use u_colonizer_worth instead of
 	u_colonizer.
 	(plan_improve): Add separate call to has_advance_to_build (2
 	times).
 	(good_cell_to_colonize): Rewrite. Check for presence of other
 	unit.  Check size goal for ALL advanced utypes. Remove check for
 	nearby enemy units.
	(plan_exploration): Support g_units_may_go_into_reserve.
	(plan_exploration): Handle GOAL_UNIT_OCCUPIED and
 	GOAL_CELL_OCCUPIED.
	(plan_exploration): Support g_units_may_go_to_sleep.
	(plan_explorer_support): Check that we can build the desired type.
	(victim_here): Also count with damage by fire and damage to occs.
	(victim_here): Give large size units higher rating.
	(victim_here): Give independent units lower rating.
	(victim_here): Give units that threaten our advanced units higher
 	rating.
	(go_after_captive): New function.
	(target_here): Also count with damage by fire and damage to occs.
	(target_here): Give large size units higher rating.
	(target_here): Give independent units lower rating.
	(target_here): Give units that threaten our advanced units higher
 	rating.
 	(capture_indep_if_nearby): Use u_ai_tactical_range.
 	(capture_useful_if_nearby): Use u_ai_tactical_range.
	* read.c (interp_unit): Restore code where ids start at 1 instead
 	of 0.
	(interp_unit): Add K_CP_STASH & K_AUTOPLAN.
	* run.c (unit_plan_dialog): New extern prototype.
	(net_resume_build_task): New extern prototype.
	(has_advance_to_research): New prototype.
	(select_by_weight): Prototype extern.
	(unit_build_dialog): Change prototype so that it returns int.
	(has_advance_to_build): Remove prototype.
	(create_selected_unit): Remove function and prototype.
	(auto_pick_new_plan): New function and prototype.
	(set_new_build_task): Remove function and prototype.
	(run_advanced_units): Enable run_construction for UNIX again.
	(run_population): Fix indepside crashes.
	(run_construction): Completely rewritten & extensively debugged.
	(auto_pick_new_research): Rewrite so that random task is picked.
	(auto_pick_new_build_task): Rewrite. Call auto_pick_new_plan.
	(auto_pick_new_plan): New function.
	* run2.c (vary_winds): Prototype.
	(update_area_display): Prototype extern.
	(run_turn_start): Check g_disable_standard_economy.
	* side.c (update_area_display): Prototype extern.
	(create_side): Fix toggle AI bug by initializing
 	newside->prefixarg.
	(side_controls_unit): Give debuggers full control.
	(side_sees_unit): Include trusted side, debuggers, g_peek_at_enemy
 	and endofgame.
	* side.h (has_advance): Fix null side crashes.
	* table.def (uu_builder_can_reuse_cp): New table.
	(uu_cellwide_protection_against): New table.
	(uu_cellwide_protection_for): New table.
	* task.c (attack_can_damage_or_capture): Move prototype to
 	kernel.h.
	(do_hit_unit_task): Count with fire and capture at pointblank
 	range.
	(do_hit_unit_task): Fix firing range bug.
	(do_hit_unit_task): Move in to capture if unit is undefended.
	(attack_can_damage_or_capture): Do attack if occ can be damaged.
	(fire_can_damage): Do attack if occ can be damaged.
	(fire_can_damage_or_capture):New function.
	(real_capture_chance): New function.
	(execute_task): Support g_ai_badtask_remove_chance.
	(execute_task): Support g_ai_badtask_max_retries.
	(execute_task): Support g_ai_badtask_reserve_chance.
	(execute_task): Support g_units_may_go_into_reserve.
	(set_build_task): Rewrite. Optionally disband any salvage
 	unfinished unit.
	(push_build_task): Rewrite. Optionally disband any salvage
 	unfinished unit.
	(set_occupy_task): New function.
	* tp.c (net_resume_build_task): New function (prototyped in
 	kpublic.h).
	* ui.c: Include MacTypes.h ifdef NEW_HEADERS, else include
 	Types.h.
	(xform_cell): Move core calculations to new function
 	xform_cell_flat.
	(xform_cell_flat): New function.
	(xform_cell_fractional_flat): New function.
	(favored_type): Check that we can build the desired type.
	* ui.h (xform_cell_flat, xform_cell_fractional_flat): New
 	prototypes.
	* unit.c (default_size): Change from 0 to 1.
	(has_advance_to_build): Remove prototype.
	(create_unit): Initialize unit->autoplan.
	(create_unit): Initialize unit->cp_stash.
	(can_carry): Check for u_facility_total_max & u_mobile_total_max.
	(type_can_occupy): Check for u_facility_total_max &
 	u_mobile_total_max.
	(type_allowed_on_side): Remove call to has_advance_to_build.
	(set_unit_side): Turn on autobuild & autoresearch if side is under
 	AI control.
	* unit.h (a_unit): Add unit->cp_stash.
	(a_unit): Add unit->autoplan.
	(for_all_occs_with_occs): Define new macro.
	(type_ever_available): Prototype extern.
	* utype.def (u_offensive_worth): New utype property.
	(u_defensive_worth): New utype property.
	(u_explorer_worth): New utype property.
	(u_colonizer_worth): New utype property.
	(u_facility_worth): New utype property.
	(u_random_worth): New utype property.
	(u_siege_worth): New utype property.
	(u_offensive): Change default from 1 to 0.
	(u_explorer): Change default from 1 to 0.
	(u_besieger): New utype property.
	(u_ship): New utype property.
	(u_ground): New utype property.
	(u_air): New utype property.
	(u_facility_total_max): New utype property.
	(u_mobile_total_max): New utype property.
	(u_ai_min_defenders) : Ner utype property.
	(u_ai_tactival_range): New utype property.
	* world.c (latlong_to_xy): Fix meridian drawing bug.
	* world.h (cell_is_within_n_steps): Rename to
 	cell_is_within_range.
	(for_all_cells_within_n_steps): Rename to
 	for_all_cells_within_range.
	(for_all_stack_with_occs): Define new macro.
	* write.c (write_area_users): Change so that nextid starts at 1
 	instead of 0.
	(write_units): Restore old code so that nextid starts at 1 instead
 	of 0.
	(write_unit_properties): Add K_AUTOPLAN & K_CP_STASH.
	* macadv.c: (MAX_DISPLAYED_FACS): New macro constant.
	(MAX_DISPLAYED_OCCS): New macro constant.
	(CLEAR_AGENDA): New macro constant.
	(unit_build_dialog): Change prototype.
	(has_advance_to_build): Remove prototype.
	(create_selected_unit): Remove prototype.
	(copy_rect_from_gworld): New function and prototype.
	(city_dialog): Rewrite. Many bug fixes and improvements.
	Most important ones:  Add conditional call to draw_unit_info.
	Use backcolor to draw region outside the area in the city map.
	Use copy_rect_from_gworld to do the offscreen graphics.
	Disable all auto checkboxes when dside is under AI control.
	Check that unit has a plan. Add new Plan Type popup menu.
	Add new Autoplan checkbox. Add new AI control checkbox.
	Split occupant panel into facilities and garrison panels.
	Fix runlength bug and limit it to CLEAR_AGENDA.
	Call net_clear_task_agenda & net_set_unit_asleep for idle units.
	Add separate call to has_advance_to_build.
	(draw_city_statistics): Rewrite. Many bug fixes and improvements.
	Most important ones: Add drawing of unit icon.
	Fix sporadic name bug by call to side_adjective.
	Fix parenthesis bug in construction status field.
	Fix crashing bug in occupant display code.
	Use u_facility_worth instead of !mobile to identify facilities.
	Add AI control info text field.	 Add new facilities and garrison
	panels.
	Fix bugs in construction status.
	Use white background color with unit icons.
	Add cps to occupant names when debugging.
	(draw_landuse_near_unit): Rename macro to for_all_cells_within_range.
	(unit_build_dialog): Rewrite. Many bug fixes. return int instead
	of *unit.
	Add separate call to has_advance_to_build.
	(unit_plan_dialog): New function and prototype.
	(global_advance_dialog): Fix autoresearch bug.
	Fix crashes due to incorrect oldprojects[] array size.
	Move SetPort call to position after conditional return.
	Fix sporadic name bug by two calls to side_adjective.
	* maccmd.c (do_set_view_angle): Only set vertscale if given a
 	valid prefixarg.
	* maccolors.c (default_draw_ai): Initialize to TRUE.
	(alert_256_colors): Initialize to TRUE.
	* macconq.c (main): Move check_screen_depths after get files and
 	make conditional.
	(update_area_display): Prototype extern. Add Side parameter.
	* macconq.h: Include MacWindows.h ifdef NEW_HEADERS, else include
 	Windows.h.
	(a_map): Add map->draw_ai.
	(default_draw_ai): New extern.
	(alert_256_colors): New extern.
	(xform_fractional): Move prototype here.
	(xform_flat): New prototype.
	(xform_fractional_flat): New prototype.
	* macdefs.h: (mPlanTypePopup): New menu.
	(miPlanTypeColonizing): New menu item.
	(miPlanTypeImproving): New menu item.
	(miPlanTypeRandom): New menu item.
	(diPrefsAIRegions): New dialog item.
	(diPrefs256colors): New dialog item.
	(dCity): All dialog items renumbered and renamed.
	(dPlan): New dialog with 3 dialog items.
	* macdraw.c (draw_unit_image): Rewrite. Support sidecolors in
 	closeups etc.
	(draw_unit_image): Restore colors BEFORE calling gray_out_rect (2
 	times).
	(draw_unit_image): Fix emblem bug due to new emblem_position code.
	* maclist.c (create_list): Use GetNewCWindow if hasColorQD.
	(draw_unit_list_entry): Fix task_desc prototype error.
	* macmap.c (xform_fractional): Move prototype to macconq.h.
	(xform_flat): New function.
	(xform_fractional_flat): New function.
	(adjust_latlong_interval): New function and prototype.
	(create_map): Use default_draw_ai.
	(create_map): Call adjust_latlong_interval.
	(set_map_power): Call adjust_latlong_interval.
	(set_map_angle): Compute a suitable vertscale.
	(draw_meridians): Fix sporadic longitude top error.
	(draw_meridians): Call xform_fractional_flat instead of
 	xform_fractional.
	(draw_selections_at): Fix (x,y) bug.
	(draw_selected_unit): Draw enemy units in red.
	(draw_selection_animation): Draw enemy units in red.
	(update_cell): Make DestRect larger to include row below.
	(update_cell): Use UNWRAP_RECT for meridians & feature names.
	* macmenus.c: (all_ai_ops): Prototype extern for use in
 	build_ai_type_menu.
	(query_position_modally): Unselect all selected units outside our
 	control.
	(do_closeup_mi): Prototype extern for use in ctrl-clicking of
 	unit.
	(build_ai_type_menu): Load AIs dynamically to the menu.
	(do_menu_command): Add support for dynamically loaded AIs.
	(do_menu_command): Support PLAN_COLONIZING & PLAN_IMPROVING.
	(apply_to_all_selected): Don't apply to selected units that we
 	don't control.
	(do_closeup_mi): Remove static declaration.
	(adjust_menus): Add support for dynamically loaded AIs.
	(adjust_menus): Don't enable commands for enemy unit closeups.
	(enable_commands_for_unit): Support PLAN_COLONIZING &
 	PLAN_IMPROVING.
	(enable_commands_for_unit): Fix menu number bug that disables More
 	menu items.
	* macmouse.c (do_closeup_mi): Prototype extern for use in
 	ctrl-clicking of unit.
	(do_mouse_down_map_content): Disable move and fire cmds for
 	selected enemy units.
	(do_mouse_down_map_content): Rewrite ctrl-clicking code using
 	side_sees_unit.  Call do_closeup_mi if ctrl-clicking non-advanced
 	unit, else call city_dialog.
	(select_all_units_in_rect): Always permit this if side_sees_unit.
	* macprefs.c (interp_mac_ui_data): Support default_draw_ai &
 	alert_256_colors.
	(ui_update_state): Support default_draw_ai & alert_256_colors.
	(set_preferences): Add case diPrefsAIRegions & diPrefs256colors.
	(set_preferences): Support default_draw_ai & alert_256_colors.
	(add_preferences_topic_items): Support default_draw_ai &
 	alert_256_colors.
	* macrow.c (draw_cliffs): Fix ouside-area crashes.
	(draw_contours): Trigger unwrapping 1 hex from right edge.
	(draw_gridlines): Trigger unwrapping 1 hex from right edge.
	(draw_shorelines): Trigger unwrapping 1 hex from right edge.
	(draw_feature_boundary_simple): Trigger unwrapping 1 hex from
 	right edge.
	* macwins.c (closeupwinwid): Change to 340.
	(init_construction_lists): Add separate call to
 	has_advance_to_build.
	(adjust_construction_controls): Check that we can build the
 	desired type.
	(side_rename_dialog): Fix colorscheme bug.
	(preferred_closeup_size): Add 4 pixels at bottom.
	(draw_unit_closeup): Make sure this is the selected unit on all
 	maps.
	(draw_unit_closeup): Optionally permit peeking at enemy units.
	(draw_unit_closeup): Fix duplicate goal_desc problem.
	(draw_unit_closeup): Align goal_desc and remove flanking junk.
	(draw_unit_closeup): Align task_desc and write "Task".
	(do_mouse_down_unit_closeup): Make sure this is the selected unit
 	on all maps.
	(destroy_unit_closeup): Make sure this is the selected unit on all
 	maps.
	* XconqProj.rsrc: (DITL 803 "City"): Extensively modified.
	(DITL 702 "Preferences Map Items"): Add AI regions checkbox.
	(DITL 704 "Preferences Offscreen Items"): Add recommend 256 colors
 	checkbox.
	(DITL 804 "City Research"): Minor changes.
	(DITL 805 "Global Science"): Minor changes.
	(DITL 807 "City Build"): Minor changes.
	(DITL 808 "City Plan"): New dialog item list.
	(DLOG 808 "City Plan"): New dialog.
	(MENU 206 "AI Types"): Remove static AI items.
	(MENU 249 "Plan Types"): Restore damaged resource. Add 3 new
 	items.
	* Xconq.r: Update from XconqProj.rsrc.
	* xconq.c (unit_build_dialog): Rewrite. Fix argument error.
	(unit_plan_dialog): New function.
----------------------------
revision 1.1
date: 1999/04/28 19:36:31;  author: shebs;  state: Exp;
Initial checkin.
=============================================================================
